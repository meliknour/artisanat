<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</title>

  <!-- Ø®Ø· Ø¬Ù…Ø§Ù„ÙŠ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#8b5a2b; --secondary:#d4a574; --light:#f9f5f0; --dark:#3a2c1e;
      --radius:12px; --shadow:0 5px 15px rgba(0,0,0,0.08);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Tajawal', Arial, sans-serif;
      background: linear-gradient(135deg,#f9f5f0 0%,#e8dfd3 100%);
      color:#222; padding:20px; min-height:100vh;
    }
    .container{
      max-width:900px; margin:20px auto; background:#fff; padding:28px;
      border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;
    }
    h1{ text-align:center; color:var(--primary); margin-bottom:18px; font-size:2rem; }
    .product-header{ display:flex; gap:20px; align-items:center; justify-content:center; flex-wrap:wrap; margin-bottom:20px; }
    .product-image{
      max-width:320px; width:100%; height:auto; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.08);
    }
    .product-title{ text-align:center; }
    .product-title h2{ font-size:1.6rem; color:var(--dark); margin-bottom:8px; }
    .meta-row{ display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap; margin-top:6px; color:#555; }
    .meta-pill{ background:var(--light); padding:8px 12px; border-radius:20px; border-right:3px solid var(--secondary); font-weight:600; }

    .product-details-grid{
      display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:16px; margin-top:18px;
    }
    .detail-item{
      background: #fbf7f3; padding:14px; border-radius:12px; display:flex; gap:12px; align-items:flex-start;
      border-right: 4px solid var(--secondary);
    }
    .detail-icon{ font-size:1.4rem; margin-left:6px; }
    .detail-label{ font-weight:700; color:var(--primary); margin-bottom:6px; display:block; }
    .detail-value{ color:var(--dark); }

    .bottom-row{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-top:22px; flex-wrap:wrap; }
    .qr-box{ text-align:center; }
    .qr-box img{ width:160px; height:160px; border:1px solid #e0d7cc; border-radius:8px; background:white; }
    .actions{ text-align:center; }
    .btn{ display:inline-block; padding:10px 16px; border-radius:10px; background:var(--primary); color:#fff; text-decoration:none; font-weight:600; box-shadow:0 4px 12px rgba(139,90,43,0.2); }
    .btn:hover{ transform:translateY(-2px); }

    .error-message{ padding:18px; border-radius:10px; background:#ffeaea; color:#d32f2f; border-right:4px solid #d32f2f; text-align:center; }

    /* Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
    .print-btn{ display:inline-block; margin:10px auto 0; padding:10px 20px; background:var(--primary); color:#fff; border:none; border-radius:10px; cursor:pointer; font-weight:700; }

    /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¹Ù„Ù‰ A4 */
    @media print {
      body{ background:#fff; padding:0; }
      .print-btn{ display:none !important; }
      .container{
        margin:0; box-shadow:none; border-radius:0; padding:20mm;
        width:210mm; min-height:297mm; /* A4 */
      }
      .product-details-grid{ gap:12px; }
      .qr-box img{ width:140px; height:140px; }
    }

    /* Responsive tweaks */
    @media (max-width:720px){
      .product-header{ flex-direction:column; }
      .product-image{ max-width:100%; }
      .qr-box img{ width:120px; height:120px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h1>

    <div id="productDetails">â³ Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

    <div style="text-align:center;">
      <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© (A4)</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ----- Ù„Ø§ ØªØºÙŠÙ‘Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ (Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù…Ø´Ø±ÙˆØ¹Ùƒ) -----
    const firebaseConfig = {
      apiKey: "AIzaSyDq-S2CBiNmccar_neNVg5T95XbwV6t0cY",
      authDomain: "artisanat-161f3.firebaseapp.com",
      projectId: "artisanat-161f3",
      storageBucket: "artisanat-161f3.appspot.com",
      messagingSenderId: "203989144161",
      appId: "1:203989144161:web:88273bf2b917ddc0a65020",
      measurementId: "G-9350J62Z5H"
    };
    // ---------------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const params = new URLSearchParams(window.location.search);
    const productId = params.get("id");
    const container = document.getElementById("productDetails");

    function formatTimestamp(ts) {
      // ÙŠØ¯Ø¹Ù… ÙƒÙ„ Ù…Ù† Date ÙˆØ³Ø¬Ù„ Firestore Timestamp
      if (!ts) return "-";
      try {
        if (typeof ts.toDate === 'function') return ts.toDate().toLocaleString();
        if (ts instanceof Date) return ts.toLocaleString();
        return String(ts);
      } catch (e) {
        return String(ts);
      }
    }

    async function loadProduct() {
      if (!productId) {
        container.innerHTML = `<div class="error-message">âŒ Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.</div>`;
        return;
      }

      try {
        const docRef = doc(db, "products", productId);
        const snap = await getDoc(docRef);

        if (!snap.exists()) {
          container.innerHTML = `<div class="error-message">âŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.</div>`;
          return;
        }

        const data = snap.data();

        // Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ø±Ø¶ (Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø«Ø§Ø¨Øª Ù„Ù„Ù…ÙˆÙ‚Ø¹ ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª)
        const viewUrl = `https://meliknour.github.io/artisanat/view.html?id=${productId}`;
        const qrSrc = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(viewUrl)}`;

        // ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬ (Ø¹Ø±Ø¶ Ø¨Ø¯Ù„ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯)
        const productImage = data.image ? data.image : "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(
          `<svg xmlns='http://www.w3.org/2000/svg' width='600' height='400'><rect width='100%' height='100%' fill='#f3ece6'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#b8a090' font-size='22'>Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</text></svg>`
        );

        // HTML Ø§Ù„Ù†Ø§ØªØ¬
        container.innerHTML = `
          <div class="product-header">
            <div class="product-title">
              <h2>${escapeHtml(data.name || "Ù…Ù†ØªØ¬ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")}</h2>
              <div class="meta-row">
                <span class="meta-pill">Ø§Ù„Ù…Ø¹Ø±Ù: ${escapeHtml(productId)}</span>
                <span class="meta-pill">Ø§Ù„Ù†ÙˆØ¹: ${escapeHtml(data.type || "-")}</span>
                <span class="meta-pill">Ø§Ù„Ø³Ø¹Ø±: ${escapeHtml(data.price || "-")}</span>
              </div>
            </div>

            <div>
              <img src="${productImage}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬" class="product-image">
            </div>
          </div>

          <div class="product-details-grid">
            <div class="detail-item"><span class="detail-icon">â±ï¸</span>
              <div><span class="detail-label">Ù…Ø¯Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</span><span class="detail-value">${escapeHtml(data.duration || "-")}</span></div>
            </div>

            <div class="detail-item"><span class="detail-icon">ğŸ“</span>
              <div><span class="detail-label">Ø§Ù„Ø­Ø¬Ù…</span><span class="detail-value">${escapeHtml(data.size || "-")}</span></div>
            </div>

            <div class="detail-item"><span class="detail-icon">âš–ï¸</span>
              <div><span class="detail-label">Ø§Ù„ÙˆØ²Ù†</span><span class="detail-value">${escapeHtml(data.weight || "-")}</span></div>
            </div>

            <div class="detail-item"><span class="detail-icon">ğŸ”§</span>
              <div><span class="detail-label">Ø§Ù„Ø§Ø³ØªØ¹Ù…Ø§Ù„</span><span class="detail-value">${escapeHtml(data.usage || "-")}</span></div>
            </div>

            <div class="detail-item"><span class="detail-icon">ğŸ¨</span>
              <div><span class="detail-label">Ø§Ù„Ø£Ù„ÙˆØ§Ù†</span><span class="detail-value">${escapeHtml(data.colors || "-")}</span></div>
            </div>

            <div class="detail-item"><span class="detail-icon">âœ¨</span>
              <div><span class="detail-label">Ù†ÙˆØ¹ Ø§Ù„ØªØ²ÙŠÙŠÙ† ÙˆØ§Ù„Ø±Ù…ÙˆØ²</span><span class="detail-value">${escapeHtml(data.decoration || "-")}</span></div>
            </div>

            <div class="detail-item"><span class="detail-icon">ğŸ­</span>
              <div><span class="detail-label">Ø§Ù„Ø¥Ù†ØªØ§Ø¬</span><span class="detail-value">${escapeHtml(data.production || "-")}</span></div>
            </div>

            <div class="detail-item"><span class="detail-icon">ğŸ“</span>
              <div><span class="detail-label">Ø§Ù„Ù…ØµØ¯Ø±</span><span class="detail-value">${escapeHtml(data.source || "-")}</span></div>
            </div>

            <div class="detail-item"><span class="detail-icon">ğŸ‘¥</span>
              <div><span class="detail-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ¯Ø®Ù„ÙŠÙ†</span><span class="detail-value">${escapeHtml(data.people || "-")}</span></div>
            </div>

            <div class="detail-item"><span class="detail-icon">ğŸ§±</span>
              <div><span class="detail-label">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©</span><span class="detail-value">${escapeHtml(data.materials || "-")}</span></div>
            </div>

            <div class="detail-item"><span class="detail-icon">ğŸ“‹</span>
              <div><span class="detail-label">Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</span><span class="detail-value">${escapeHtml(data.steps || "-")}</span></div>
            </div>

            <div class="detail-item"><span class="detail-icon">ğŸ› ï¸</span>
              <div><span class="detail-label">Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³ØªØ¹Ù…Ù„Ø©</span><span class="detail-value">${escapeHtml(data.tools || "-")}</span></div>
            </div>

            <div class="detail-item"><span class="detail-icon">ğŸ”¬</span>
              <div><span class="detail-label">Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ¹Ù…Ù„Ø©</span><span class="detail-value">${escapeHtml(data.techniques || "-")}</span></div>
            </div>

            <div class="detail-item"><span class="detail-icon">ğŸ’¡</span>
              <div><span class="detail-label">Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ù…Ø¨ØªÙƒØ±Ø©</span><span class="detail-value">${escapeHtml(data.innovation || "-")}</span></div>
            </div>

            <div class="detail-item"><span class="detail-icon">ğŸ“…</span>
              <div><span class="detail-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</span><span class="detail-value">${formatTimestamp(data.timestamp)}</span></div>
            </div>
          </div>

          <div class="bottom-row">
            <div class="qr-box">
              <div style="margin-bottom:8px;font-weight:700;color:var(--primary)">Ù…Ø³Ø­ Ø±Ù…Ø² QR Ù„ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶</div>
              <img src="${qrSrc}" alt="QR code">
            </div>

            <div class="actions">
              <a class="btn" href="view.html?id=${encodeURIComponent(productId)}" target="_blank">ÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶</a>
              <a class="btn" href="edit.html?id=${encodeURIComponent(productId)}" style="background:#f39c12;margin-left:10px;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</a>
            </div>
          </div>
        `;
      } catch (err) {
        console.error(err);
        container.innerHTML = `<div class="error-message">âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬.</div>`;
      }
    }

    // Ø­Ù…Ø§ÙŠØ© Ø¨Ø³ÙŠØ·Ø© Ù„Ù…Ù†Ø¹ XSS Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ù†ØµÙˆØµ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function escapeHtml(str){
      if (str === null || str === undefined) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    loadProduct();
  </script>
</body>
</html>
