<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import QRCode from "https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js";

  // إعداد Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDq-S2CBiNmccar_neNVg5T95XbwV6t0cY",
    authDomain: "artisanat-161f3.firebaseapp.com",
    projectId: "artisanat-161f3",
    storageBucket: "artisanat-161f3.firebasestorage.app",
    messagingSenderId: "203989144161",
    appId: "1:203989144161:web:88273bf2b917ddc0a65020",
    measurementId: "G-9350J62Z5H"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  function getCheckedValues(name) {
    return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`))
                .map(cb => cb.value).join(" - ");
  }

  document.getElementById("saveButton").addEventListener("click", async () => {
    const data = {
      productName: document.getElementById("productName").value,
      productImageUrl: document.getElementById("productImageUrl").value,
      productType: getCheckedValues("productType"),
      uses: getCheckedValues("uses"),
      size: document.getElementById("size").value,
      weight: getCheckedValues("weight"),
      decoration: getCheckedValues("decoration"),
      production: getCheckedValues("production"),
      materialSource: getCheckedValues("materialSource"),
      rawMaterials: document.getElementById("rawMaterials").value,
      stages: document.getElementById("stages").value,
      tools: document.getElementById("tools").value,
      contributors: document.getElementById("contributors").value,
      colors: document.getElementById("colors").value,
      duration: document.getElementById("duration").value,
      techniques: document.getElementById("techniques").value,
      innovations: document.getElementById("innovations").value,
      price: document.getElementById("price").value,
      createdAt: new Date().toISOString()
    };

    try {
      const docRef = await addDoc(collection(db, "products"), data);
      const id = docRef.id;
      const url = `https://meliknour.github.io/artisanat/index.html?id=${id}`;

      document.getElementById("qrcode").innerHTML = "";
      new QRCode(document.getElementById("qrcode"), {
        text: url,
        width: 128,
        height: 128
      });

      alert("✅ تم حفظ المنتج! افتح الرابط: " + url);
    } catch (e) {
      console.error("❌ خطأ:", e);
      alert("حدث خطأ، راجع الكونسول");
    }
  });
</script>
