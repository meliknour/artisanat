<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>صفحة المنتج</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <div id="product">
    <h2 id="productName">اسم المنتج</h2>
    <p id="productDesc">وصف المنتج هنا</p>
    <img id="productImage" src="https://via.placeholder.com/150" alt="صورة المنتج" />
    <div id="qrCode"></div>
    <button onclick="downloadPDF()">تحميل PDF</button>
  </div>

  <script>
    const productData = {
      name: document.getElementById("productName").innerText,
      desc: document.getElementById("productDesc").innerText,
      image: document.getElementById("productImage").src,
      link: window.location.href
    };

    // توليد QR
    new QRCode(document.getElementById("qrCode"), {
      text: productData.link,
      width: 128,
      height: 128
    });

    // تحويل أي صورة إلى Base64
    function loadImageForPDF(url) {
      return new Promise((resolve, reject) => {
        let img = new Image();
        img.crossOrigin = "Anonymous";
        img.onload = function () {
          let canvas = document.createElement("canvas");
          canvas.width = this.width;
          canvas.height = this.height;
          let ctx = canvas.getContext("2d");
          ctx.drawImage(this, 0, 0);
          resolve(canvas.toDataURL("image/png"));
        };
        img.onerror = reject;
        img.src = url;
      });
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      let yPosition = 20;

      doc.setFontSize(16);
      doc.text("بطاقة تقنية للمنتوج", 105, yPosition, { align: "center" });
      yPosition += 20;

      doc.setFontSize(12);
      doc.text(`اسم المنتج: ${productData.name}`, 10, yPosition);
      yPosition += 10;
      doc.text(`الوصف: ${productData.desc}`, 10, yPosition);
      yPosition += 20;

      // إضافة صورة المنتج
      if (productData.image) {
        try {
          const imgData = await loadImageForPDF(productData.image);
          if (imgData) {
            const imgWidth = 80;
            const imgHeight = 60;
            doc.addImage(imgData, 'PNG', (210 - imgWidth) / 2, yPosition, imgWidth, imgHeight);
            yPosition += imgHeight + 20;
          }
        } catch (error) {
          console.error("خطأ في تحميل صورة المنتج:", error);
        }
      }

      // إضافة QR Code
      try {
        const qrCanvas = document.querySelector("#qrCode canvas");
        if (qrCanvas) {
          const qrData = qrCanvas.toDataURL("image/png");
          doc.addImage(qrData, "PNG", (210 - 50) / 2, yPosition, 50, 50);
          yPosition += 60;
        }
      } catch (error) {
        console.error("خطأ في إضافة QR:", error);
      }

      doc.save("fiche-technique.pdf");
    }
  </script>
</body>
</html>
