<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>بطاقة تقنية للمنتوج</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    .product-img { width: 300px; margin: 20px auto; }
    .qr { margin-top: 20px; }
    button { margin-top: 20px; padding: 10px; }
  </style>
</head>
<body>
  <h1>بطاقة تقنية للمنتوج</h1>
  <div id="product"></div>
  <button onclick="generatePDF()">تحميل PDF</button>

<script>
  // إعداد Firebase
  const firebaseConfig = {
    apiKey: "YOUR_KEY",
    authDomain: "artisanat-161f3.firebaseapp.com",
    projectId: "artisanat-161f3",
    storageBucket: "artisanat-161f3.appspot.com",
    messagingSenderId: "YOUR_ID",
    appId: "YOUR_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // تحميل المنتج الأول
  let currentProduct = null;
  async function loadProduct() {
    const snap = await db.collection("products").limit(1).get();
    if (!snap.empty) {
      const data = snap.docs[0].data();
      currentProduct = data;
      document.getElementById("product").innerHTML = `
        <h2>${data.name}</h2>
        <img src="${data.image}" class="product-img">
        <div class="qr"><img src="${data.qr}"></div>
      `;
    }
  }
  loadProduct();

  // تحويل الصورة إلى Base64
  function getBase64ImageFromUrl(url) {
    return new Promise((resolve, reject) => {
      let img = new Image();
      img.setAttribute("crossOrigin", "anonymous");
      img.onload = () => {
        let canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        let ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        resolve(canvas.toDataURL("image/png"));
      };
      img.onerror = error => reject(error);
      img.src = url;
    });
  }

  // توليد PDF
  async function generatePDF() {
    if (!currentProduct) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(18);
    doc.text("بطاقة تقنية للمنتوج", 70, 20);

    // صورة المنتج في الوسط
    if (currentProduct.image) {
      const productImg = await getBase64ImageFromUrl(currentProduct.image);
      doc.addImage(productImg, "PNG", 55, 40, 100, 100);
    }

    // QR في الأسفل
    if (currentProduct.qr) {
      const qrImg = await getBase64ImageFromUrl(currentProduct.qr);
      doc.addImage(qrImg, "PNG", 80, 150, 50, 50);
    }

    doc.save("fiche-technique.pdf");
  }
</script>
</body>
</html>
